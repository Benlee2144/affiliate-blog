{{ define "head" }}
<!-- Article Schema.org JSON-LD -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "{{ if .Params.review }}Review{{ else }}Article{{ end }}",
    "headline": "{{ .Title }}",
    "description": "{{ .Description }}",
    "datePublished": "{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}",
    "dateModified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
    "author": {
        "@type": "Person",
        "name": "{{ .Site.Params.author }}",
        "url": "{{ .Site.BaseURL }}author/ben-arp/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "{{ .Site.Title }}",
        "logo": {
            "@type": "ImageObject",
            "url": "{{ .Site.BaseURL }}images/logo.svg"
        }
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ .Permalink }}"
    }
    {{ if .Params.review }}
    ,"itemReviewed": {
        "@type": "Product",
        "name": "{{ .Params.product_name }}",
        "image": "{{ .Params.product_image | absURL }}"
        {{ with .Params.brand }},"brand": { "@type": "Brand", "name": "{{ . }}" }{{ end }}
    },
    "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ .Params.rating | default 4 }}",
        "bestRating": "5"
    }
    {{ with .Params.pros }}
    ,"positiveNotes": {
        "@type": "ItemList",
        "itemListElement": [
            {{ range $i, $pro := . }}{{ if $i }},{{ end }}
            {
                "@type": "ListItem",
                "position": {{ add $i 1 }},
                "name": "{{ $pro }}"
            }
            {{ end }}
        ]
    }
    {{ end }}
    {{ with .Params.cons }}
    ,"negativeNotes": {
        "@type": "ItemList",
        "itemListElement": [
            {{ range $i, $con := . }}{{ if $i }},{{ end }}
            {
                "@type": "ListItem",
                "position": {{ add $i 1 }},
                "name": "{{ $con }}"
            }
            {{ end }}
        ]
    }
    {{ end }}
    {{ end }}
}
</script>

{{ if .Params.product_name }}
<!-- Product Schema.org JSON-LD with AggregateRating + Pros/Cons -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ .Params.product_name }}",
    "description": "{{ .Description }}",
    "image": "{{ .Params.product_image | absURL }}",
    {{ with .Params.brand }}"brand": { "@type": "Brand", "name": "{{ . }}" },{{ end }}
    "review": {
        "@type": "Review",
        "reviewRating": {
            "@type": "Rating",
            "ratingValue": "{{ .Params.rating | default 4 }}",
            "bestRating": "5"
        },
        "author": {
            "@type": "Person",
            "name": "{{ .Site.Params.author }}",
            "url": "{{ .Site.BaseURL }}author/ben-arp/"
        }
        {{ with .Params.pros }}
        ,"positiveNotes": {
            "@type": "ItemList",
            "itemListElement": [
                {{ range $i, $pro := . }}{{ if $i }},{{ end }}
                { "@type": "ListItem", "position": {{ add $i 1 }}, "name": "{{ $pro }}" }
                {{ end }}
            ]
        }
        {{ end }}
        {{ with .Params.cons }}
        ,"negativeNotes": {
            "@type": "ItemList",
            "itemListElement": [
                {{ range $i, $con := . }}{{ if $i }},{{ end }}
                { "@type": "ListItem", "position": {{ add $i 1 }}, "name": "{{ $con }}" }
                {{ end }}
            ]
        }
        {{ end }}
    }
    {{ with .Params.amazon_rating }}
    ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ . }}",
        "bestRating": "5",
        "ratingCount": "{{ $.Params.amazon_review_count | default 100 }}"
    }
    {{ end }}
    {{ with .Params.price }}
    ,"offers": {
        "@type": "Offer",
        "url": "{{ $.Params.affiliate_link }}",
        "priceCurrency": "USD",
        "price": "{{ replace . "$" "" }}",
        "availability": "https://schema.org/InStock",
        "seller": {
            "@type": "Organization",
            "name": "Amazon"
        }
    }
    {{ end }}
}
</script>
{{ end }}

{{ if .Params.faq }}
<!-- FAQ Schema.org JSON-LD -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {{ range $i, $faq := .Params.faq }}
        {{ if $i }},{{ end }}
        {
            "@type": "Question",
            "name": "{{ $faq.question }}",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "{{ $faq.answer }}"
            }
        }
        {{ end }}
    ]
}
</script>
{{ end }}

<!-- BreadcrumbList Schema.org JSON-LD -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ .Site.BaseURL }}"
        }
        {{ with .Params.categories }}
        ,{
            "@type": "ListItem",
            "position": 2,
            "name": "{{ index . 0 }}",
            "item": "{{ $.Site.BaseURL }}categories/{{ index . 0 | urlize }}/"
        }
        ,{
            "@type": "ListItem",
            "position": 3,
            "name": "{{ $.Title }}"
        }
        {{ else }}
        ,{
            "@type": "ListItem",
            "position": 2,
            "name": "{{ .Title }}"
        }
        {{ end }}
    ]
}
</script>
{{ end }}

{{ define "main" }}
<!-- Reading Progress Bar -->
<div class="reading-progress" id="reading-progress"></div>

<article class="container">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs">
        <a href="/">Home</a>
        <span>‚Ä∫</span>
        {{ with .Params.categories }}
        <a href="/categories/{{ index . 0 | urlize }}/">{{ index . 0 }}</a>
        <span>‚Ä∫</span>
        {{ end }}
        <span>{{ .Title | truncate 50 }}</span>
    </nav>

    <header class="post-header">
        <h1>{{ .Title }}</h1>
        <div class="post-meta">
            {{ with .Params.author }}
            <span class="post-author">
                <span class="author-avatar-small">{{ substr . 0 1 }}</span>
                By <a href="/author/ben-arp/" style="color: inherit; text-decoration: underline dotted;">{{ . }}</a>
            </span>
            {{ end }}
            <span>Updated {{ .Lastmod.Format "January 2, 2006" }}</span>
            {{ if .ReadingTime }}<span>{{ .ReadingTime }} min read</span>{{ end }}
        </div>
        <!-- Visible last-updated for freshness signal -->
        {{ if not (eq (.Date.Format "2006-01-02") (.Lastmod.Format "2006-01-02")) }}
        <div style="font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem;">
            Originally published {{ .Date.Format "January 2, 2006" }} ¬∑ Last updated {{ .Lastmod.Format "January 2, 2006" }}
        </div>
        {{ end }}
    </header>

    <!-- Hero Image -->
    {{ with .Params.cover.image }}
    <div class="post-hero-image">
        <img src="{{ . }}" alt="{{ $.Params.cover.alt | default $.Title }}" loading="eager" fetchpriority="high">
    </div>
    {{ end }}

    <!-- Affiliate Disclosure (FTC-compliant, top of every review) -->
    {{ if .Params.review }}
    <div class="affiliate-disclosure" style="background: #fef9f0; border: 1px solid #f0e4d0; border-radius: 8px; padding: 0.875rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.875rem; line-height: 1.5;">
        <strong>üìã Disclosure:</strong> We independently research every product on this page. When you buy through our links, we may earn a commission at no extra cost to you. We only recommend products we'd genuinely tell a friend to buy. <a href="/affiliate-disclosure/" style="color: var(--color-accent);">Full disclosure ‚Üí</a>
    </div>
    {{ end }}

    <!-- Pros/Cons Box (if provided in frontmatter) -->
    {{ if or .Params.pros .Params.cons }}
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; font-size: 0.95rem;">
        {{ with .Params.pros }}
        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem 1.25rem;">
            <strong style="color: #16a34a;">‚úÖ What We Like</strong>
            <ul style="margin: 0.5rem 0 0; padding-left: 1.25rem;">
                {{ range . }}<li>{{ . }}</li>{{ end }}
            </ul>
        </div>
        {{ end }}
        {{ with .Params.cons }}
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem 1.25rem;">
            <strong style="color: #dc2626;">‚ùå What We Don't</strong>
            <ul style="margin: 0.5rem 0 0; padding-left: 1.25rem;">
                {{ range . }}<li>{{ . }}</li>{{ end }}
            </ul>
        </div>
        {{ end }}
    </div>
    {{ end }}

    <div class="post-content">
        {{ .Content }}
    </div>

    <!-- FAQ Section (from front matter) -->
    {{ with .Params.faq }}
    <section class="faq-section">
        <h2>Frequently Asked Questions</h2>
        {{ range . }}
        <div class="faq-item" itemscope itemprop="mainEntity" itemtype="https://schema.org/Question">
            <h4 itemprop="name">{{ .question }}</h4>
            <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                <p itemprop="text">{{ .answer }}</p>
            </div>
        </div>
        {{ end }}
    </section>
    {{ end }}

    <!-- Author Bio -->
    <div class="author-bio">
        <div class="author-avatar">BA</div>
        <div class="author-info">
            <h4><a href="/author/ben-arp/" style="color: inherit; text-decoration: none;">Ben Arp</a></h4>
            <p class="author-title">Founder & Lead Researcher</p>
            <p class="author-description">I spend hours digging through Amazon reviews, Reddit threads, and forum posts to find products that are actually worth buying. <a href="/author/ben-arp/">More about me ‚Üí</a></p>
        </div>
    </div>

    <!-- Tags -->
    {{ with .Params.tags }}
    <div class="tags">
        {{ range . }}
        <a href="/tags/{{ . | urlize }}/" class="tag">#{{ . }}</a>
        {{ end }}
    </div>
    {{ end }}

    <!-- Post footer info -->
    <div class="post-info">
        <div class="reading-time">
            {{ if .ReadingTime }}{{ .ReadingTime }} min read{{ end }}
        </div>
        <div class="share-buttons">
            <a href="https://twitter.com/intent/tweet?url={{ .Permalink }}&text={{ .Title }}" target="_blank" rel="noopener" aria-label="Share on Twitter">ùïè</a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}" target="_blank" rel="noopener" aria-label="Share on Facebook">f</a>
            <a href="https://pinterest.com/pin/create/button/?url={{ .Permalink }}&description={{ .Title }}" target="_blank" rel="noopener" aria-label="Share on Pinterest">P</a>
        </div>
    </div>

    <!-- Related Posts -->
    {{ $related := .Site.RegularPages.Related . | first 4 }}
    {{ with $related }}
    <section class="related-posts-section">
        <h2>You Might Also Like</h2>
        <div class="related-posts-grid">
            {{ range . }}
            <a href="{{ .Permalink }}" class="related-post-card">
                {{ with .Params.cover.image }}
                <img src="{{ . }}" alt="{{ $.Title }}" class="related-post-image" loading="lazy">
                {{ else }}
                <div class="related-post-image"></div>
                {{ end }}
                <div class="related-post-info">
                    <h4>{{ .Title | truncate 60 }}</h4>
                    <div class="related-post-meta">
                        {{ with .Params.rating }}<span class="related-post-rating">‚òÖ {{ . }}</span> ¬∑ {{ end }}
                        {{ .Date.Format "Jan 2, 2006" }}
                    </div>
                </div>
            </a>
            {{ end }}
        </div>
    </section>
    {{ end }}
</article>

<!-- Sticky Mobile CTA -->
{{ if and .Params.review .Params.affiliate_link }}
<div class="sticky-cta" id="sticky-cta">
    <div class="sticky-cta-content">
        <div class="sticky-cta-info">
            <div class="product-name">{{ .Params.product_name | truncate 30 }}</div>
            {{ with .Params.price }}<div class="product-price">{{ . }}</div>{{ end }}
        </div>
        <a href="{{ .Params.affiliate_link }}" class="cta-button" target="_blank" rel="noopener sponsored">
            {{ with .Params.price }}{{ . }} at {{ end }}Amazon
        </a>
    </div>
</div>
<script>document.body.classList.add('has-sticky-cta');</script>
{{ end }}

<!-- Reading Progress Script -->
<script>
(function() {
    const progressBar = document.getElementById('reading-progress');
    const article = document.querySelector('.post-content');
    if (!article || !progressBar) return;
    function updateProgress() {
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.scrollY;
        const start = articleTop - windowHeight;
        const end = articleTop + articleHeight - windowHeight;
        const progress = Math.min(Math.max((scrollTop - start) / (end - start) * 100, 0), 100);
        progressBar.style.width = progress + '%';
    }
    window.addEventListener('scroll', updateProgress, { passive: true });
    updateProgress();
})();
</script>
{{ end }}
