{{ define "main" }}
{{ if .IsHome }}
<!-- Disclosure bar -->
<div class="disclosure-bar">
    <div class="container">
        <span>We independently research everything we recommend. When you buy through our links, we may earn a commission.</span>
        <a href="/affiliate-disclosure/">Learn more ›</a>
    </div>
</div>

<!-- HOMEPAGE - Wirecutter-style three-column hero + category sections -->
<div class="container home-content">
    <!-- Hero three-column section -->
    {{ $allPages := .Site.RegularPages.ByDate.Reverse }}
    <section class="hero-section">
        <!-- Left: The latest -->
        <div class="hero-latest">
            <h2 class="section-heading">The latest</h2>
            <div class="latest-list">
                {{ range first 6 $allPages }}
                {{ $postTitle := .Title }}
                <div class="latest-item">
                    <a href="{{ .Permalink }}" class="latest-item-link">
                        {{ with .Params.cover.image }}
                        <img class="latest-thumb" src="{{ . }}" alt="{{ $postTitle }}" loading="lazy" width="80" height="80">
                        {{ else }}
                        <div class="latest-thumb latest-thumb-placeholder"></div>
                        {{ end }}
                        <div class="latest-item-text">
                            <span class="latest-title">{{ .Title }}</span>
                            <span class="latest-date">Updated {{ .Date.Format "Jan. 2" }}</span>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Center: Featured article -->
        {{ with index $allPages 0 }}
        {{ $featuredTitle := .Title }}
        <div class="hero-featured">
            <a href="{{ .Permalink }}" class="hero-featured-image">
                {{ with .Params.cover.image }}
                <img src="{{ . }}" alt="{{ $featuredTitle }}" fetchpriority="high" width="600" height="400">
                {{ else }}
                <div class="placeholder-image"></div>
                {{ end }}
            </a>
            <h2 class="hero-featured-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h2>
            <p class="hero-featured-byline">by {{ .Params.author | default "Researched Picks" }}</p>
            <p class="hero-featured-summary">{{ .Summary | plainify | htmlUnescape | truncate 200 }}</p>
        </div>
        {{ end }}

        <!-- Right: Recent picks -->
        <div class="hero-deals">
            <h2 class="section-heading">Top picks</h2>
            <p class="section-subheading">Our research-backed recommendations</p>
            <div class="deals-list">
                {{ range after 6 (first 12 $allPages) }}
                {{ $dealTitle := .Title }}
                <div class="deal-item">
                    {{ with .Params.categories }}
                    <span class="deal-category">{{ index . 0 }}</span>
                    {{ end }}
                    <a href="{{ .Permalink }}">
                        {{ with .Params.cover.image }}
                        <img src="{{ . }}" alt="{{ $dealTitle }}" loading="lazy" width="100" height="100">
                        {{ end }}
                        <span>{{ .Title | truncate 60 }}</span>
                    </a>
                </div>
                {{ end }}
            </div>
        </div>
    </section>

    <!-- Category sections -->
    {{ range $catName, $catPages := .Site.Taxonomies.categories }}
    {{ $pages := $catPages.Pages.ByDate.Reverse }}
    {{ if ge (len $pages) 1 }}
    <section class="category-section">
        <div class="category-section-header">
            <a href="/categories/{{ $catName | urlize }}/" class="category-label">{{ $catPages.Page.Title }}</a>
        </div>
        <div class="category-section-content">
            <!-- Featured article (first/newest) -->
            {{ with index $pages 0 }}
            {{ $catFeaturedTitle := .Title }}
            <div class="featured-article">
                <a href="{{ .Permalink }}" class="featured-image">
                    {{ with .Params.cover.image }}
                    <img src="{{ . }}" alt="{{ $catFeaturedTitle }}" loading="lazy" width="400" height="300">
                    {{ else }}
                    <div class="placeholder-image"></div>
                    {{ end }}
                </a>
                <div class="featured-info">
                    <h3 class="featured-title"><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
                    <p class="featured-byline">{{ with .Params.author }}By {{ . }} · {{ end }}Updated {{ .Date.Format "Jan. 2, 2006" }}</p>
                    <p class="featured-summary">{{ .Summary | plainify | htmlUnescape | truncate 180 }}</p>
                </div>
            </div>
            {{ end }}

            <!-- Side article list (next 2-3 posts) -->
            {{ if gt (len $pages) 1 }}
            <div class="article-list">
                {{ range after 1 (first 4 $pages) }}
                {{ $articleTitle := .Title }}
                <div class="article-list-item">
                    <a href="{{ .Permalink }}" class="article-list-item-link">
                        {{ with .Params.cover.image }}
                        <img class="article-list-thumb" src="{{ . }}" alt="{{ $articleTitle }}" loading="lazy" width="120" height="90">
                        {{ else }}
                        <div class="article-list-thumb article-list-thumb-placeholder"></div>
                        {{ end }}
                        <div class="article-list-item-text">
                            <h4>{{ .Title }}</h4>
                            <p class="article-list-byline">{{ with .Params.author }}By {{ . }} · {{ end }}Updated {{ .Date.Format "Jan. 2, 2006" }}</p>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </section>
    {{ end }}
    {{ end }}

    <!-- Newsletter at very bottom -->
    <section class="newsletter-section">
        <h2>Get Our Latest Picks</h2>
        <p>New reviews and deals, straight to your inbox. No spam — just the good stuff.</p>
        <form class="newsletter-form" action="https://formspree.io/f/mykdgbyq" method="POST">
            <input type="email" name="email" placeholder="Enter your email" required>
            <button type="submit">Subscribe</button>
        </form>
        <p class="newsletter-note">Unsubscribe anytime. We respect your inbox.</p>
    </section>
</div>

{{ else }}
<!-- CATEGORY/SECTION PAGES -->
<div class="container">
    <header class="page-header">
        <h1>{{ .Title }}</h1>
        {{ with .Description }}<p>{{ . }}</p>{{ end }}
    </header>

    <div class="reviews-grid">
        {{ $paginator := .Paginate .Pages }}
        {{ range $paginator.Pages }}
        {{ $cardTitle := .Title }}
        <article class="review-card">
            <a href="{{ .Permalink }}" class="review-card-image">
                {{ with .Params.cover.image }}
                <img src="{{ . }}" alt="{{ $cardTitle }}" loading="lazy" width="800" height="600">
                {{ else }}
                <div style="width:100%;height:100%;background:var(--color-bg-alt);"></div>
                {{ end }}
            </a>
            <div class="review-card-content">
                {{ with .Params.categories }}
                <a href="/categories/{{ index . 0 | urlize }}/" class="review-card-category">{{ index . 0 }}</a>
                {{ end }}
                <h3><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
                <p class="review-card-summary">{{ .Summary | truncate 120 }}</p>
                <div class="review-card-meta">
                    <span class="review-card-date">{{ .Date.Format "Jan 2, 2006" }}</span>
                </div>
            </div>
        </article>
        {{ end }}
    </div>

    {{ if gt $paginator.TotalPages 1 }}
    <nav class="pagination">
        {{ if $paginator.HasPrev }}
        <a href="{{ $paginator.Prev.URL }}">← Previous</a>
        {{ end }}
        {{ range $paginator.Pagers }}
        {{ if eq . $paginator }}
        <span class="active">{{ .PageNumber }}</span>
        {{ else }}
        <a href="{{ .URL }}">{{ .PageNumber }}</a>
        {{ end }}
        {{ end }}
        {{ if $paginator.HasNext }}
        <a href="{{ $paginator.Next.URL }}">Next →</a>
        {{ end }}
    </nav>
    {{ end }}
</div>
{{ end }}
{{ end }}
